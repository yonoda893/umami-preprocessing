
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the umami preprocessing framework">
      
      
        <meta name="author" content="Umami Team">
      
      
        <link rel="canonical" href="https://umami-hep.github.io/umami-preprocessing/">
      
      
      
        <link rel="next" href="setup/">
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.5">
    
    
      
        <title>UPP: Umami Preprocessing</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.558e4712.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#upp-umami-preprocessing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="." title="UPP: Umami Preprocessing" class="md-header__button md-logo" aria-label="UPP: Umami Preprocessing" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            UPP: Umami Preprocessing
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Introduction
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/umami-hep/umami-preprocessing/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Github
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="UPP: Umami Preprocessing" class="md-nav__button md-logo" aria-label="UPP: Umami Preprocessing" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    UPP: Umami Preprocessing
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/umami-hep/umami-preprocessing/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    Github
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Introduction
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="." class="md-nav__link md-nav__link--active">
        Introduction
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#motivation" class="md-nav__link">
    Motivation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hybrid-samples" class="md-nav__link">
    Hybrid Samples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#this-package" class="md-nav__link">
    This package
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="setup/" class="md-nav__link">
        Setup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="sampling/" class="md-nav__link">
        Sampling methods
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="configuration/" class="md-nav__link">
        Configuration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="run/" class="md-nav__link">
        Run
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="umami_int/" class="md-nav__link">
        Umami integration
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="contributing/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#motivation" class="md-nav__link">
    Motivation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hybrid-samples" class="md-nav__link">
    Hybrid Samples
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#this-package" class="md-nav__link">
    This package
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



<h1 id="upp-umami-preprocessing">UPP: Umami Preprocessing<a class="headerlink" href="#upp-umami-preprocessing" title="Permanent link">#</a></h1>
<p>Welcome to the Umami PreProcessing (UPP) package, a modular preprocessing pipeline for jet tagging.
UPP is used to prepare datasets for training various taggers. 
In particular, it handles hybrid sample creation, resampling, normalisation, and shuffling.</p>
<p>The code is hosted on the Github:</p>
<ul>
<li><a href="https://github.com/umami-hep/umami-preprocessing">https://github.com/umami-hep/umami-preprocessing</a></li>
</ul>
<p>You can find information about tagger training and FTAG software at the central <a href="https://ftag.docs.cern.ch/algorithms/GNN/">docs pages</a>.</p>
<details class="info" open="open">
<summary>UPP tutorial</summary>
<p>A tutorial on how to use the framework is provided at the <a href="update-link">central FTAG docs page</a></p>
</details>
<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">#</a></h2>
<p>Input ntuples for the preprocessing are produced using the <a href="https://gitlab.cern.ch/atlas-flavor-tagging-tools/training-dataset-dumper">training-dataset-dumper</a> which converts from ROOT files to HDF5 ntuples.
A list of available h5 ntuples is maintained in the central <a href="https://ftag.docs.cern.ch/software/samples/">FTAG documentation pages</a>.
However, the ntuples listed there are not directly suitable for algorithm training and require preprocessing (handled by this package).</p>
<p>This library is alredy used to preprocess data for <a href="https://gitlab.cern.ch/atlas-flavor-tagging-tools/algorithms/salt/">Salt</a> framework.
UPP is planned to be integrated into <a href="https://gitlab.cern.ch/atlas-flavor-tagging-tools/algorithms/umami">Umami</a> framework for training of Umami/DIPS and DL1r and replace current umami preprocessing, as it addresses <a href="https://gitlab.cern.ch/atlas-flavor-tagging-tools/algorithms/umami/-/issues/?label_name%5B%5D=Preprocessing">several issues</a> with the current umami preprocessing workflow, and uses the <a href="https://github.com/umami-hep/atlas-ftag-tools/"><code>atlas-ftag-tools</code></a> package extensively.</p>
<h2 id="motivation">Motivation<a class="headerlink" href="#motivation" title="Permanent link">#</a></h2>
<p>The primary motivation behind preprocessing the training samples is to ensure that the distributions of kinematic variables such as <span class="arithmatex"><span class="MathJax_Preview">p_T</span><script type="math/tex">p_T</script></span> and <span class="arithmatex"><span class="MathJax_Preview">\eta</span><script type="math/tex">\eta</script></span> are the same for all flavors.
This uniformity in kinematic distributions is crucial to avoid kinematic biases in the tagging performance.
In order to ensure the uniformity in kinematic distributions, resampling techniques are employed.
These techniques involve removing samples from the majority class (under-sampling) and/or adding more samples from the minority class (over-sampling).</p>
<p>The preprocessing can also be used to control the number of jets of each flavour, to stitch together jets from various samples, and to perform the shuffling and normalisation.</p>
<h2 id="hybrid-samples">Hybrid Samples<a class="headerlink" href="#hybrid-samples" title="Permanent link">#</a></h2>
<p>Umami/DIPS and DL1r are trained on so-called hybrid samples created by combining <span class="arithmatex"><span class="MathJax_Preview">t\bar{t}</span><script type="math/tex">t\bar{t}</script></span> and <span class="arithmatex"><span class="MathJax_Preview">Z'</span><script type="math/tex">Z'</script></span> jets using a <span class="arithmatex"><span class="MathJax_Preview">p_T</span><script type="math/tex">p_T</script></span> threshold, which is defined by the <code>pt_btagJes</code>.
Below a certain pt threshold (which needs to be defined for the preprocessing), <span class="arithmatex"><span class="MathJax_Preview">t\bar{t}</span><script type="math/tex">t\bar{t}</script></span> events are used in the hybrid sample.
Above this pt threshold, the jets are taken from <span class="arithmatex"><span class="MathJax_Preview">Z'</span><script type="math/tex">Z'</script></span> events.
The advantage of these hybrid samples is the availability of sufficient jets with high pt, as the <span class="arithmatex"><span class="MathJax_Preview">t\bar{t}</span><script type="math/tex">t\bar{t}</script></span> samples typically have lower-pt jets than those jets from the <span class="arithmatex"><span class="MathJax_Preview">Z'</span><script type="math/tex">Z'</script></span> sample.</p>
<p>The following image show the distributions of jet flavours in both samples</p>
<p><img alt="Pt distribution of hybrid samples being composed from ttbar and Zjets samples" src="assets/pt_btagJes-cut_spectrum.png" /></p>
<p>After applying <code>pdf</code> resampling with upscaling, we achieve the following combined distributions for jets:</p>
<p><img alt="pT distribution of downsampled hybrid samples" src="assets/train_pt_btagJes.png" /></p>
<p>It's worth noting that, while we used <span class="arithmatex"><span class="MathJax_Preview">t\bar{t}</span><script type="math/tex">t\bar{t}</script></span> and <span class="arithmatex"><span class="MathJax_Preview">Z'</span><script type="math/tex">Z'</script></span> samples here for illustrative purposes, you can use any type of samples.
Additionally, you're not obligated to create a hybrid sample; UPP can still be used with a single sample for preprocessing.</p>
<h2 id="this-package">This package<a class="headerlink" href="#this-package" title="Permanent link">#</a></h2>
<p>Compared with <a href="https://gitlab.cern.ch/atlas-flavor-tagging-tools/algorithms/umami">umami</a>, the main features of this code are:</p>
<ul>
<li>modular, class-based design</li>
<li>use of h5 virtual datasets to wrap the source files</li>
<li>only 2 main stages: resample -&gt; merge -&gt; done!</li>
<li>parallelised processing of flavours within a sample, which avoids wasted reads</li>
<li>support for different resampling "regions", which is useful for generalising to <a href="https://gitlab.cern.ch/atlas-flavor-tagging-tools/algorithms/umami/-/issues/225">Xbb preprocessing</a></li>
<li>n-dim sampling support, which is also useful for Xbb</li>
<li>"new" improved training file format (which is actually just the tdd output format)<ul>
<li>structured arrays are smaller on disk and therefore faster to read</li>
<li>only one dataloader is needed and can be reused for training and testing</li>
<li>other plotting scripts can support a single file format</li>
<li>normalisation/concatenation is applied on the fly during training</li>
<li>training files can contain supersets of variables used for training</li>
</ul>
</li>
<li>new "countup" samping which is more efficient than pdf (it uses more the available statistics and reduces duplication of jets)</li>
<li>the code estimates the number of unique jets for you and saves this number as an attribute in the output file</li>
</ul>
<p>These features yield the following benefits as compared with umami:</p>
<ul>
<li>only one command is needed to generate all preprocessing outputs (running with <code>--split=all</code> will produce train/val/test files)</li>
<li>lines of code are reduced vs umami by 4x</li>
<li>10x faster than default umami preprocessing (0.06 vs 0.825 hours/million jets in an old test)</li>
<li>improvements to output file size and read speed</li>
</ul>

  <hr>
<div class="md-source-file">
  <small>
    
      Last update:
      <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">June 13, 2024</span>
      
        <br>
        Created:
        <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">June 13, 2024</span>
      
    
  </small>
</div>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 - 2023 CERN for the benefit of the ATLAS collaboration
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": ".", "features": ["content.code.copy"], "search": "assets/javascripts/workers/search.e5c33ebb.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="assets/javascripts/bundle.51d95adb.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>